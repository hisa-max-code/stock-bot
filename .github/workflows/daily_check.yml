name: Market Monitor and History Tracker

on:
  schedule:
    # 毎日 平日の日本時間 22:00 (UTC 13:00) に実行
    - cron: '0 13 * * 1-5'
  workflow_dispatch: # 手動実行も可能にする

permissions:
  contents: write # リポジトリへの書き込み権限を許可（CSV保存に必須）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.8' # Kotaさんの環境に合わせたバージョン

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas requests

    - name: Run Market Monitor Script
      env:
        MY_DISCORD_URL: ${{ secrets.MY_DISCORD_URL }}
      run: python main.py # 実行ファイル名が main.py であると想定しています

    - name: Commit and Push History CSV
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Market-Monitor-Bot"
        git add market_history.csv
        # 変更がある場合のみコミットを行う
        if ! git diff --cached --exit-code; then
          git commit -m "Update market history [skip ci]"
          git push
        else
          echo "No changes in history file."
        fi
